#!/bin/bash

################################################################################
##
## Copyright 2019 - 2020, GÃ¶teborg Bit Factory.
## All rights reserved.
##
################################################################################

if [[ -z "${HOLIDATA}" ]] ; then
  echo "You have to specify the location of the 'holidata' script via the HOLIDATA environment variable!"
  exit 1
fi

if [[ ! -f "${HOLIDATA}" || "${HOLIDATA##*/}" != "holidata" ]] ; then
  echo "'${HOLIDATA}' does not point to 'holidata'!"
  exit 1
fi

SCRIPT="$( pwd )/${BASH_SOURCE[0]}"
BASE="${SCRIPT%/bin/*}"
DOCROOT="${BASE}/html"
LOCALE_TEXT="${DOCROOT}/locale_index.txt"
LOCALE_HTML="${DOCROOT}/locale_index.html"
LOCALE_TEMPLATE="${BASE}/bin/template_locale.html"
MAP_HTML="${DOCROOT}/map.html"
MAP_TEMPLATE="${BASE}/bin/template_map.html"

while [[ -n "${1}" ]] ; do
  case ${1} in
    [a-z][a-z]-[A-Z][A-Z])
      locales=( "${locales[@]}" "${1}" )
      ;;
    [0-9][0-9][0-9][0-9])
      years+=( "${1}" )
      ;;
    --all-years)
      while IFS='' read -r line; do years+=("$line"); done < <( seq "2011" "$( date "+%Y" )" )
      ;;
    --all-locales)
      while IFS=' ' read -r line ; do locales+=( "${line}" ) ; done <  <( find "${DOCROOT}" -name "??-??" | sed "s|${DOCROOT}/\(..-..\)|\1|" )
      ;;
    --commit)
      DO_COMMIT="yes"
      ;;
    -*)
      echo "Invalid option '${1}'"
      exit 1
      ;;
    *)
      echo "Invalid argument '${1}'"
      exit 1
      ;;
  esac
  shift
done

if [[ ${#locales[@]} -eq 0 ]] ; then
  echo "No locale specified!"
  exit 1
elif [[ ${#locales[@]} -eq 1 && ${#years[@]} -eq 0 ]] ; then
  if [[ ! -d "${DOCROOT}/${locales[0]}" ]] ; then
    echo "No data exists for locale ${locales[0]}!"
    exit 1
  fi
  while IFS=' ' read -r line ; do years+=( "${line}" ) ; done <  <( find "${DOCROOT}/${locales[0]}" -name "[0-9][0-9][0-9][0-9].*" | sed "s|${DOCROOT}/${locales[0]}/\(....\)\..*|\1|"  | sort -u )
fi

if [[ ${#years[@]} -eq 0 ]] ; then
  echo "No year specified!"
  exit 1
fi

if [[ "${DO_COMMIT-no}" == "yes" ]] ; then
  echo "Cleaning repository..."
  git -C "${BASE}" checkout -- "${DOCROOT}"
  git -C "${BASE}" clean -f "${DOCROOT}"
fi

echo "Processing ${#locales[@]} locale(s), ${#years[@]} year(s) each..."

for locale in "${locales[@]}" ; do
  if [[ ! -d "${DOCROOT}/${locale}" ]] ; then
    echo "Generating locale '${locale}' dir..."
    mkdir -p "${DOCROOT}/${locale}"
  fi

  for year in "${years[@]}" ; do
    if [[ -e "${DOCROOT}/${locale}/${year}.*" ]] ; then
      ACTION="Update"
    fi
    echo "Generating locale '${locale}' files for ${year}..."
    for format in "csv" "json" "yaml" "xml" ; do
      echo -en "Generating ${locale}/${year}.${format}           \r"
      "${HOLIDATA}" --year="${year}" --locale="${locale}" --output="${format}" > "${DOCROOT}/${locale}/${year}.${format}" || { rm "${DOCROOT}/${locale}/${year}.${format}" ; continue 3 ; }
    done

    cd "${BASE}/bin" >/dev/null || exit
    # Generate the locale index page from the generated data formats
    echo "Generating locale index..."
    ./gen-locales --docroot "${DOCROOT}" --text "${LOCALE_TEXT}" --html "${LOCALE_HTML}" --template "${LOCALE_TEMPLATE}"

    # Generate the map page from the generated data formats
    echo "Generating map page..."
    ./gen-map --docroot "${DOCROOT}" --html "${MAP_HTML}" --template "${MAP_TEMPLATE}"

    cd - >/dev/null || exit

    echo "Generated locale ${locale} for year ${year}"

    if [[ "${DO_COMMIT-no}" == "yes" ]] ; then
      git -C "${BASE}" add "${DOCROOT}/${locale}"

      if git diff --cached --quiet "${DOCROOT}/${locale}" ; then
        echo "No changes to holidata files in ${locale} for ${year}!"
      else
        git -C "${BASE}" commit -m "${ACTION-Add} holidays for ${locale} ${year}" "${DOCROOT}" || exit 1
      fi
    fi
  done
done
